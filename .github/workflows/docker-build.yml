name: üê≥ Build and Validate Docker Backend

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # ‚úÖ Permite ejecuci√≥n manual desde la interfaz de GitHub Actions

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Clona el repositorio del proyecto
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configura el entorno de ejecuci√≥n con JDK 17
      # Se utiliza la distribuci√≥n Temurin (Adoptium), recomendada por la comunidad.
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: maven  # ‚ö°Ô∏è Habilita la cach√© de dependencias Maven para optimizar el pipeline

      # 3Ô∏è‚É£ Verifica la conectividad hacia el repositorio Maven Central
      # Esta validaci√≥n garantiza que el entorno tenga acceso para descargar dependencias.
      - name: Verify Maven Central connectivity
        run: |
          echo "Verificando acceso a Maven Central..."
          curl -I https://repo1.maven.org/maven2/

      # 4Ô∏è‚É£ Compila el proyecto y genera el archivo .jar del backend
      # Se omiten las pruebas (-DskipTests) ya que no se requiere validaci√≥n funcional en este flujo.
      - name: Build with Maven
        working-directory: scripts/backend
        run: mvn clean package -DskipTests --batch-mode
        env:
          MAVEN_OPTS: "-Dmaven.repo.remote=https://repo1.maven.org/maven2"

      # 5Ô∏è‚É£ Configura Docker Buildx
      # Buildx permite la construcci√≥n avanzada de im√°genes Docker multiplataforma.
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6Ô∏è‚É£ Construye la imagen Docker del backend
      # Se etiqueta la imagen con un nombre local 'bioprint-backend' para referencia posterior.
      - name: Build Docker image
        working-directory: scripts/backend
        run: docker build -t bioprint-backend .

      # 7Ô∏è‚É£ Crea un contenedor a partir de la imagen reci√©n construida (sin ejecutarlo)
      # Esto valida que Docker pueda montar el contenedor correctamente sin errores de configuraci√≥n.
      - name: Validate container creation
        run: |
          echo "Verificando creaci√≥n de contenedor sin ejecuci√≥n..."
          docker create --name bioprint-test bioprint-backend
          docker ps -a | grep bioprint-test
          docker rm bioprint-test
        # üß† El comando `docker create` crea el contenedor sin iniciarlo,
        # `docker ps -a` lista todos los contenedores (incluso detenidos),
        # y `docker rm` elimina el contenedor de validaci√≥n.
